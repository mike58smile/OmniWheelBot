\hypertarget{_state_8h_source}{}\doxysection{State.\+h}
\mbox{\hyperlink{_state_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*****************************************************************/}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#ifndef \_STATE\_h}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#define \_STATE\_h}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#if defined(ARDUINO) \&\& ARDUINO >= 100}}
\DoxyCodeLine{14 \textcolor{preprocessor}{    \#include "{}arduino.h"{}}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{16 \textcolor{preprocessor}{    \#include "{}WProgram.h"{}}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{18 }
\DoxyCodeLine{19 \textcolor{preprocessor}{\#define USE\_TIMER\_2 true}}
\DoxyCodeLine{20 \textcolor{keyword}{constexpr} \textcolor{keyword}{auto} \mbox{\hyperlink{_state_8h_ace81b7721cfd2a469849f25fc66c43ff}{TimerSpeedDelay\_mS}} = 30; }
\DoxyCodeLine{21 \textcolor{keyword}{constexpr} \textcolor{keyword}{auto} \mbox{\hyperlink{_state_8h_a4cc6036eff1c3ecb0dd8898afb14e46d}{TimerSpeedDelay\_uS}} = \mbox{\hyperlink{_state_8h_ace81b7721cfd2a469849f25fc66c43ff}{TimerSpeedDelay\_mS}} * 1000; }
\DoxyCodeLine{22 \textcolor{keyword}{constexpr} \textcolor{keywordtype}{float} EncToRealSpd(\textcolor{keywordtype}{int} EncSpeed) \{}
\DoxyCodeLine{23     \textcolor{keywordflow}{return}((\textcolor{keywordtype}{float}(EncSpeed) * TWO\_PI) / (979.2 * (\textcolor{keywordtype}{float}(\mbox{\hyperlink{_state_8h_ace81b7721cfd2a469849f25fc66c43ff}{TimerSpeedDelay\_mS}}) / 1000.0)));}
\DoxyCodeLine{24 \}}
\DoxyCodeLine{25 \textcolor{keyword}{static} \textcolor{keyword}{inline} int8\_t sign(\textcolor{keywordtype}{int} val) \{}
\DoxyCodeLine{26     \textcolor{keywordflow}{if} (val < 0) \textcolor{keywordflow}{return} -\/1;}
\DoxyCodeLine{27     \textcolor{keywordflow}{if} (val == 0) \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{28     \textcolor{keywordflow}{return} 1;}
\DoxyCodeLine{29 \}}
\DoxyCodeLine{30 \textcolor{comment}{// User defined data types:}}
\DoxyCodeLine{31 \textcolor{comment}{//enum class is better cause the name of the enum elements can be used outside the enum as variables}}
\DoxyCodeLine{32 \textcolor{keyword}{enum class} MainState \{ Setup, Speed, Stop \}; }
\DoxyCodeLine{33 \textcolor{keyword}{enum class} CommState \{ Stop, Wait, SpeedPWM, SpeedReal, Unknown \}; }
\DoxyCodeLine{34 \textcolor{keyword}{using }Pin = \textcolor{keyword}{const} uint8\_t;}
\DoxyCodeLine{35 }
\DoxyCodeLine{39 \textcolor{keyword}{class }\mbox{\hyperlink{class_state_class}{StateClass}}}
\DoxyCodeLine{40 \{}
\DoxyCodeLine{41  \textcolor{keyword}{protected}:}
\DoxyCodeLine{42 }
\DoxyCodeLine{43  \textcolor{keyword}{public}:}
\DoxyCodeLine{44      \textcolor{keyword}{const} \textcolor{keywordtype}{char}* \mbox{\hyperlink{class_state_class_afa32621b6be04b8b8538c877d9397d7c}{MainStatePrint}}[3] = \{ \textcolor{stringliteral}{"{}Setup"{}}, \textcolor{stringliteral}{"{}Speed"{}}, \textcolor{stringliteral}{"{}Stop"{}} \}; }
\DoxyCodeLine{45      \textcolor{keyword}{const} \textcolor{keywordtype}{char}* \mbox{\hyperlink{class_state_class_a180c7c89c514d821cfe840e812d9bf35}{CommStatePrint}}[5] = \{ \textcolor{stringliteral}{"{}Stop"{}}, \textcolor{stringliteral}{"{}Wait"{}}, \textcolor{stringliteral}{"{}SpeedPWM"{}}, \textcolor{stringliteral}{"{}SpeedReal"{}}, \textcolor{stringliteral}{"{}Unknown"{}} \}; }
\DoxyCodeLine{46 \textcolor{comment}{// Define pins}}
\DoxyCodeLine{47      \textcolor{comment}{//Motor1}}
\DoxyCodeLine{48      \textcolor{keyword}{static} Pin M1\_LPWM = 5;}
\DoxyCodeLine{49      \textcolor{keyword}{static} Pin M1\_RPWM = 6;}
\DoxyCodeLine{50      \textcolor{keyword}{static} Pin M1\_REN = 4;}
\DoxyCodeLine{51      \textcolor{keyword}{static} Pin M1\_LEN = 7;}
\DoxyCodeLine{52      \textcolor{comment}{//Motor2}}
\DoxyCodeLine{53      \textcolor{keyword}{static} Pin M2\_RPWM = 10;}
\DoxyCodeLine{54      \textcolor{keyword}{static} Pin M2\_LPWM = 11;}
\DoxyCodeLine{55      \textcolor{keyword}{static} Pin M2\_REN = 8;}
\DoxyCodeLine{56      \textcolor{keyword}{static} Pin M2\_LEN = 9;}
\DoxyCodeLine{57      \textcolor{comment}{//define Encoder pins}}
\DoxyCodeLine{58      \textcolor{keyword}{static} Pin Enc1\_1 = 2;}
\DoxyCodeLine{59      \textcolor{keyword}{static} Pin Enc1\_2 = 12;}
\DoxyCodeLine{60      \textcolor{keyword}{static} Pin Enc2\_1 = 3;}
\DoxyCodeLine{61      \textcolor{keyword}{static} Pin Enc2\_2 = A0;}
\DoxyCodeLine{62 }
\DoxyCodeLine{63 \textcolor{comment}{// Other definitions}}
\DoxyCodeLine{64      \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{int} address = 0x10;}
\DoxyCodeLine{65 }
\DoxyCodeLine{66 \textcolor{comment}{// Regulator parameters}}
\DoxyCodeLine{67      \textcolor{keyword}{const} \textcolor{keywordtype}{int} motor1DeadBand[2] = \{ 10,10 \}; \textcolor{comment}{// [forward,backward] -\/ What is the minimum PWM value on which Motor 1 starts rotating}}
\DoxyCodeLine{68      \textcolor{keyword}{const} \textcolor{keywordtype}{int} motor2DeadBand[2] = \{ 10,10 \}; \textcolor{comment}{// [forward,backward] -\/ What is the minimum PWM value on which Motor 2 starts rotating}}
\DoxyCodeLine{69 \textcolor{comment}{// Non const variables -\/ will be changed during program}}
\DoxyCodeLine{70      }
\DoxyCodeLine{71      MainState \mbox{\hyperlink{class_state_class_a3b06994bd0056d2f5c9b7037defeec13}{actualState}} = MainState::Setup; }
\DoxyCodeLine{72      CommState \mbox{\hyperlink{class_state_class_af71f651eebc7746f9c57a33520180c60}{commState}} = CommState::Stop; }
\DoxyCodeLine{73 }
\DoxyCodeLine{74      \textcolor{keywordtype}{int} \mbox{\hyperlink{class_state_class_a37816025e4f99f25401ae08862a660c9}{actualSpeed}}[2] = \{ 0,0 \}; }
\DoxyCodeLine{75      \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} \mbox{\hyperlink{class_state_class_a581cb51181287947b25b549ab5f67d7d}{encSpeed}}[2] = \{ 0,0 \}; }
\DoxyCodeLine{76      \textcolor{keywordtype}{int} \mbox{\hyperlink{class_state_class_ad35700f8b8ec016a81c9b9ff2f049791}{requiredSpeed}}[2] = \{ 0,0 \}; }
\DoxyCodeLine{77      \textcolor{keywordtype}{float} \mbox{\hyperlink{class_state_class_a262f7357126ca5e0bc0c12c7243df553}{actualRealSpeed}}[2] = \{ 0,0 \}; }
\DoxyCodeLine{78      \textcolor{keywordtype}{float} \mbox{\hyperlink{class_state_class_a78697ac64c2a18d1d3885fc5ce29178a}{requiredRealSpeed}}[2] = \{ 0,0 \}; }
\DoxyCodeLine{79 \};}
\DoxyCodeLine{80 }
\DoxyCodeLine{81 \textcolor{keyword}{extern} \mbox{\hyperlink{class_state_class}{StateClass}} State;}
\DoxyCodeLine{82 }
\DoxyCodeLine{83 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{84 }
\DoxyCodeLine{85 \textcolor{comment}{/* Garbage:}}
\DoxyCodeLine{86 \textcolor{comment}{Initialization of static const array in .h file}}
\DoxyCodeLine{87 \textcolor{comment}{     static const uint8\_t Enc1Pin(size\_t index) \{}}
\DoxyCodeLine{88 \textcolor{comment}{         static const uint8\_t x[] = \{ 1,2 \};}}
\DoxyCodeLine{89 \textcolor{comment}{         return x[index];}}
\DoxyCodeLine{90 \textcolor{comment}{     \}}}
\DoxyCodeLine{91 \textcolor{comment}{*/}}
\DoxyCodeLine{92 }
\DoxyCodeLine{93 \textcolor{comment}{/* RPM Debounce}}
\DoxyCodeLine{94 \textcolor{comment}{ Relative to RPM readout and triggering to start  a thread path:}}
\DoxyCodeLine{95 \textcolor{comment}{}}
\DoxyCodeLine{96 \textcolor{comment}{  Index debounce will affect the sensitivity of the index signal. IT basically is how many interrupt periods the signal must be present, or not present before a change is actually sensed in that line. SO if set to 2 for example, when the index appears it will be ignored for 2 periods to make sure it isnt noise. Same with when it disappears. Setting debounce too high will make the index go away altogether.}}
\DoxyCodeLine{97 \textcolor{comment}{}}
\DoxyCodeLine{98 \textcolor{comment}{  Since the length of the index is dependent on spindle speed, minimum length is variable, but the time must be at least 1 period at a debounce of zero. SO in 25000, thats 40us.}}
\DoxyCodeLine{99 \textcolor{comment}{  If a person notices a dropoff in RPM at a certain speed, they need usually a lower index debounce. Index inputs from an encoder are usually pretty short and will limit speed readings at some point as you go higher.}}
\DoxyCodeLine{100 \textcolor{comment}{}}
\DoxyCodeLine{101 \textcolor{comment}{If you have the debounce setting too high the axis will just sit there waiting to confirm the rpm}}
\DoxyCodeLine{102 \textcolor{comment}{before the start of a thread path.}}
\DoxyCodeLine{103 \textcolor{comment}{}}
\DoxyCodeLine{104 \textcolor{comment}{Don't have specifics relative to switches .}}
\DoxyCodeLine{105 \textcolor{comment}{ */}}
\DoxyCodeLine{106 }
\DoxyCodeLine{107 \textcolor{comment}{//READ spd with millis}}
\DoxyCodeLine{108 \textcolor{comment}{//     unsigned long currentMillis\_1 = 0;}}
\DoxyCodeLine{109 \textcolor{comment}{//     unsigned long previousMillis\_1 = 0;}}
\DoxyCodeLine{110 \textcolor{comment}{// }}
\DoxyCodeLine{111  \textcolor{comment}{//    currentMillis\_1 = millis();}}
\DoxyCodeLine{112  \textcolor{comment}{//    if ((currentMillis\_1 -\/ previousMillis\_1) >= 200) \{}}
\DoxyCodeLine{113  \textcolor{comment}{//        encSpeed[0] = abs(Drive.enc1.read());}}
\DoxyCodeLine{114  \textcolor{comment}{//        Drive.enc1.write(0);}}
\DoxyCodeLine{115  \textcolor{comment}{//        encSpeed[1] = abs(Drive.enc2.read());}}
\DoxyCodeLine{116  \textcolor{comment}{//        Drive.enc2.write(0);}}
\DoxyCodeLine{117  \textcolor{comment}{//;       previousMillis\_1 = currentMillis\_1;}}
\DoxyCodeLine{118  \textcolor{comment}{//    \}}}
\DoxyCodeLine{119 }
\DoxyCodeLine{120 }
\DoxyCodeLine{121 \textcolor{comment}{// Using timer interrupt}}
\DoxyCodeLine{122 \textcolor{comment}{// INCLUDES}}
\DoxyCodeLine{123 \textcolor{comment}{// \#include <ISR\_Timer.h>}}
\DoxyCodeLine{124 \textcolor{comment}{//\#include <TimerInterrupt.hpp>}}
\DoxyCodeLine{125 \textcolor{comment}{//\#include <TimerInterrupt.h>}}
\DoxyCodeLine{126 \textcolor{comment}{//\#include <ISR\_Timer.hpp> }}
\DoxyCodeLine{127 }
\DoxyCodeLine{128 \textcolor{comment}{//SETUP:}}
\DoxyCodeLine{129 \textcolor{comment}{// Timer init}}
\DoxyCodeLine{130 \textcolor{comment}{//ITimer2.init();}}
\DoxyCodeLine{131 \textcolor{comment}{//if (ITimer2.attachInterruptInterval(TimerSpeedDelayMS, TimerSpeedHandler))}}
\DoxyCodeLine{132 \textcolor{comment}{//\{}}
\DoxyCodeLine{133 \textcolor{comment}{//    Serial.println(F("{}Starting  ITimer1 OK, millis() = "{})); Serial.println(millis());}}
\DoxyCodeLine{134 \textcolor{comment}{//\}}}
\DoxyCodeLine{135 \textcolor{comment}{//else}}
\DoxyCodeLine{136 \textcolor{comment}{//    Serial.println(F("{}Can't set ITimer1. Select another freq. or timer"{}));}}
\DoxyCodeLine{137 }
\DoxyCodeLine{138 \textcolor{comment}{//GLOBAL in .ino}}
\DoxyCodeLine{139 \textcolor{comment}{//Global variables}}
\DoxyCodeLine{140 \textcolor{comment}{//static volatile bool flagReadSpeed = 0; ///< Will be set true in interrupt routine}}
\DoxyCodeLine{141 \textcolor{comment}{//static volatile int interruptNum = 0; ///< Will increment in interrupt routine}}
\DoxyCodeLine{142 \textcolor{comment}{//void TimerSpeedHandler()}}
\DoxyCodeLine{143 \textcolor{comment}{//\{}}
\DoxyCodeLine{144 \textcolor{comment}{//    flagReadSpeed = 1;}}
\DoxyCodeLine{145 \textcolor{comment}{//    ++interruptNum;}}
\DoxyCodeLine{146 \textcolor{comment}{//\}}}
\DoxyCodeLine{147 }
\DoxyCodeLine{148 \textcolor{comment}{//In void loop:}}
\DoxyCodeLine{149 \textcolor{comment}{//if (flagReadSpeed) \{}}
\DoxyCodeLine{150 \textcolor{comment}{//    Drive.read();}}
\DoxyCodeLine{151 \textcolor{comment}{//    flagReadSpeed = 0;}}
\DoxyCodeLine{152 \textcolor{comment}{//    interruptNum = 0;}}
\DoxyCodeLine{153 \textcolor{comment}{//\}}}
\DoxyCodeLine{154 }
\DoxyCodeLine{155 \textcolor{comment}{//In Drive.read:}}
\DoxyCodeLine{156 \textcolor{comment}{//State.encSpeed[0] = abs(enc1.read());}}
\DoxyCodeLine{157 \textcolor{comment}{//enc1.write(0);}}
\DoxyCodeLine{158 \textcolor{comment}{//State.encSpeed[1] = abs(enc2.read());}}
\DoxyCodeLine{159 \textcolor{comment}{//enc2.write(0);}}

\end{DoxyCode}
